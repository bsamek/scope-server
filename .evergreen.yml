#######################################################################################
# scout-server Evergreen CI configuration
#
# References:
# https://github.com/evergreen-ci/evergreen/wiki/Project-Files
# https://github.com/evergreen-ci/evergreen/blob/master/config_dev/project/sample.yml
#######################################################################################

stepback: false

pre:
- command: shell.track

post:
- command: shell.cleanup

variables:
# function "fetch npm tarball" is conditional on the following
# -> all except windows
- &fetch_npm_tarball_variants
  - osx-108
  - ubuntu

# function "upgrade npm windows" is conditional based on {upgrade_npm_version}
# as set in the buildvariant declaration
# -> only windows

# function "save release variants" is conditional on the following
# -> all except ubuntu
- &save_release_variants
  - osx-108
  - windows-64


#######################################
#            Functions                #
#######################################

functions:
  "fetch source" :
    - command: git.get_project
      params:
        directory: src
    - command: git.apply_patch
      params:
        directory: src
    - command: shell.exec
      params:
        working_dir: src
        script: |
          mkdir .deps

  # Install node,npm from a tarball in S3 to src/.deps/bin
  # To use "npm" installed by this, each shell.exec script must add:
  #     export PATH="$PATH:${node_path|}"
  "fetch npm tarball" :
    - command: s3.get
      params:
        build_variants:
          *fetch_npm_tarball_variants
        aws_key: ${aws_key_evergreen_integrations}
        aws_secret: ${aws_secret_evergreen_integrations}
        bucket: mongodb-dx-public
        remote_file: evergreen-deps/${fetch_npm_tarball}
        local_file: src/.deps/${fetch_npm_tarball}
    - command: shell.exec
      params:
        working_dir: src/.deps
        script: |
          if [ -z "${fetch_npm_tarball|}" ]; then
            echo "fetch_npm_tarball: fetch_npm_tarball is unset; skipping"
            exit 0
          fi
          set -ev
          tar xzf ${fetch_npm_tarball} --strip-components=1
          ls

  # THIS COMMAND WORKS ON WINDOWS ONLY, SHOULD BE CONSIDERED OBSOLETE
  # To use "npm" installed by this, each shell.exec script must add:
  #     export PATH="`npm -g bin`:$PATH"
  "upgrade npm windows" :
    - command: shell.exec
      params:
        working_dir: src
        script: |
          if [ -z "${upgrade_npm_version|}" ]; then
            echo "upgrade_npm: upgrade_npm_version is unset; skipping"
            exit 0
          fi
          set -ev
          test -n "${add_environment|}" && export "${add_environment|}"
          export PATH="$PATH:${node_path|}"
          ${npm|npm} install -g npm@${upgrade_npm_version|xx}

  "npm install" :
    - command: shell.exec
      params:
        working_dir: src
        script: |
          set -ev
          test -n "${add_environment|}" && export "${add_environment|}"
          export PATH="$PATH:${node_path|}"
          export PATH="`npm -g bin`:$PATH"
          ${node|node} --version
          ${npm|npm} --version
          ${npm|npm} config set loglevel error
          ${npm|npm} config -g list -l
          ${npm|npm} install

  "npm run check" :
    - command: shell.exec
      params:
        working_dir: src
        continue_on_err: false
        script: |
          set -ev
          test -n "${add_environment|}" && export "${add_environment|}"
          export PATH="$PATH:${node_path|}"
          export PATH="`npm -g bin`:$PATH"
          export CI=1;
          export EVERGREEN=1;
          ${npm|npm} run check

# ---------------------------

  "npm run ci_26_standalone" :
    - command: shell.exec
      params:
        working_dir: src
        continue_on_err: false
        script: |
          set -ev
          test -n "${add_environment|}" && export "${add_environment|}"
          export PATH="$PATH:${node_path|}"
          export PATH="`npm -g bin`:$PATH"
          export CI=1 EVERGREEN=1;
          export MONGODB_VERSION=2.6.x MONGODB_TOPOLOGY=standalone
          ${npm|npm} run ci
    - command: attach.results
      params:
        file_location: src/report.json

  "npm run ci_31_standalone" :
    - command: shell.exec
      params:
        working_dir: src
        continue_on_err: false
        script: |
          set -ev
          test -n "${add_environment|}" && export "${add_environment|}"
          export PATH="$PATH:${node_path|}"
          export PATH="`npm -g bin`:$PATH"
          export CI=1 EVERGREEN=1;
          export MONGODB_VERSION=3.1.x MONGODB_TOPOLOGY=standalone
          ${npm|npm} run ci
    - command: attach.results
      params:
        file_location: src/report.json

# ---------------------------

  "snapshot save" :
    - command: archive.targz_pack
      params:
        target: "snapshot.tgz"
        source_dir: "src"
        include:
          - "*"
        exclude_files:
          - "coverage"
          - "docs"
    - command: s3.put
      params:
        aws_key: ${aws_key}
        aws_secret: ${aws_secret}
        local_file: snapshot.tgz
        remote_file: 10gen-scout-server-master/${build_variant}/${revision}/snapshot/${build_id}.tgz
        bucket: mciuploads
        permissions: public-read
        content_type: application/tar
        display_name: Artifacts

  "snapshot fetch" :
    command: s3.get
    params:
      aws_key: ${aws_key}
      aws_secret: ${aws_secret}
      remote_file: 10gen-scout-server-master/${build_variant}/${revision}/snapshot/${build_id}.tgz
      bucket: mciuploads
      extract_to: src

#######################################
#               Tasks                 #
#######################################

tasks:
- name: compile
  depends_on: []
  commands:
  - func: "fetch source"
  - func: "fetch npm tarball"
  - func: "upgrade npm windows"
  - func: "npm install"
  - func: "npm run check"
  - func: "snapshot save"

- name: ci_26_standalone
  depends_on:
  - name: compile
  commands:
  - func: "fetch npm tarball"
  - func: "upgrade npm windows"
  - func: "snapshot fetch"
  - func: "npm run ci_26_standalone"

- name: ci_31_standalone
  depends_on:
  - name: compile
  commands:
  - func: "fetch npm tarball"
  - func: "upgrade npm windows"
  - func: "snapshot fetch"
  - func: "npm run ci_31_standalone"


# # Used for tests that invoke resmoke.py and require no additional setup.
# - &task_template
#   name: template
#   depends_on:
#   - name: compile
#   commands:
#   - func: "do setup"
#   - func: "run tests"
#     vars:
#       resmoke_args: --help
#       run_multiple_jobs: false


# - <<: *task_template
#   name: aggregation
#   commands:
#   - func: "do setup"
#   - func: "run tests"
#     vars:
#       resmoke_args: --suites=aggregation --storageEngine=mmapv1


#######################################
#           Buildvariants             #
#######################################

buildvariants:
- name: osx-108
  display_name: OS X 10.8
  modules: ~
  run_on:
  - "osx-108"
  expansions:
    fetch_npm_tarball: node-v0.12.7-npm-3.3.5-darwin-x64.tgz
    node_path: "$(pwd)/.deps/bin"
  tasks:
  - name: compile
  - name: ci_26_standalone
  - name: ci_31_standalone

- name: windows-64
  display_name: Windows 64-bit
  modules: ~
  run_on:
  - "windows-64-vs2013-test"
  expansions:
    add_environment: "APPDATA=C:\\Program Files (x86)\\nodejs\\node_modules"
    upgrade_npm_version: "3"
    node_path: "/cygdrive/c/Program Files (x86)/nodejs"
  tasks:
  - name: compile
  - name: ci_26_standalone
  - name: ci_31_standalone

- name: ubuntu
  display_name: Ubuntu 14.04
  modules: ~
  run_on:
  - "ubuntu1404-test"
  expansions:
    fetch_npm_tarball: node-v0.12.7-npm-3.3.5-linux-x64.tar.gz
    node_path: "$(pwd)/.deps/bin"
    compile_env: CC=/opt/mongodbtoolchain/bin/gcc CXX=/opt/mongodbtoolchain/bin/g++
  tasks:
  - name: compile
  - name: ci_26_standalone
  - name: ci_31_standalone
